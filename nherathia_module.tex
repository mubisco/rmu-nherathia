% !TeX program = xelatex

\documentclass[10pt,a4paper,oneside]{book}

\usepackage{polyglossia}
\setmainlanguage{spanish}
\usepackage{fontspec}
\setmainfont{CrimsonPro}[
    Path = fonts/,
    Extension = .ttf,
    UprightFont = *-Regular,
    BoldFont = *-Bold,
    ItalicFont = *-Italic,
    BoldItalicFont = *-BoldItalic
]
\usepackage{csquotes}
\usepackage{geometry}
\geometry{margin=2.5cm}

% Layout packages
\usepackage{multicol}               % Two-column layout
\usepackage{graphicx}               % Images
\usepackage[most]{tcolorbox}       % Colored boxes for widgets
\usepackage{titlesec}               % Better chapter/section formatting
\usepackage{eso-pic}                % Background images
\usepackage{tikz}                   % For opacity control
\usepackage{xcolor}
\usepackage{xparse}
\usepackage{enumitem}

\titlespacing*{\subsubsection}{0pt}{1.5ex plus 1ex minus .2ex}{0.5ex plus .2ex}

% ============================================================================
% COLOR THEME DEFINITIONS (HTML format for easy editing)
% ============================================================================
% Read Aloud Box colors
\definecolor{ReadAloudBorder}{HTML}{CC6600}   % Orange-brown border
\definecolor{ReadAloudBG}{HTML}{FFFFFF}       % White background

% Rules Box colors
\definecolor{RulesBorder}{HTML}{3366CC}       % Blue border
\definecolor{RulesBG}{HTML}{E6F0FF}           % Light blue background
\definecolor{RulesTitleBG}{HTML}{3366CC}      % Blue title background

% NPC Sheet colors
\definecolor{NPCBorder}{HTML}{2E8B57}         % Sea green border
\definecolor{NPCBG}{HTML}{F0FFF0}             % Honeydew background

% ============================================================================
% PARCHMENT BACKGROUND
% ============================================================================
\AddToShipoutPictureBG{%
  \AtPageLowerLeft{%
    \begin{tikzpicture}
      \node[inner sep=0pt,opacity=0.50] {\includegraphics[width=\paperwidth,height=\paperheight]{images/parchment.jpg}};
    \end{tikzpicture}%
  }%
}

% ============================================================================
% CUSTOM WIDGET DEFINITIONS
% ============================================================================

% Widget 1: Read Aloud Box (for player descriptions)
\newtcolorbox{readaloud}{
  enhanced,
  breakable,
  colback=ReadAloudBG,
  colframe=ReadAloudBorder,
  boxrule=0pt,
  leftrule=3pt,
  rightrule=3pt,
  toprule=0pt,
  bottomrule=0pt,
  sharp corners=all,
  left=8pt, right=8pt, top=5pt, bottom=5pt
}

% Widget 2: Rules/Clarifications Box
\newtcolorbox{rulesbox}{
  enhanced,
  breakable,
  colback=RulesBG,
  colframe=RulesBorder,
  fonttitle=\bfseries,
  title=Reglas,
  attach boxed title to top left={yshift=-2mm, xshift=5mm},
  boxed title style={
    colback=RulesTitleBG,
    sharp corners
  },
  sharp corners=all,
  boxrule=1pt,
  left=5pt, right=5pt, top=8pt, bottom=5pt,
  before skip=8pt plus 2pt,
  after skip=8pt plus 2pt
}

% Widget 3: NPC Sheet Environment (readable, named sections)
% Usage: \begin{npcsheet}[subtitle][image]{NPC Name} ... \end{npcsheet}
\NewDocumentEnvironment{npcsheet}{O{} O{} m}{%
  % #1 = optional subtitle
  % #2 = optional image path
  % #3 = NPC name (title)
  \def\npcsubtitle{#1}%
  \def\npcimagedata{#2}%
  \def\npcname{#3}%
  \def\npcappearance{}%
  \def\npcvoice{}%
  \def\npcmotivation{}%
  \def\npcsecrets{}%
  % Commands to set each field
  \newcommand{\npcimage}[1]{\def\npcimagedata{##1}}%
  \newcommand{\appearance}[1]{\def\npcappearance{##1}}%
  \newcommand{\voice}[1]{\def\npcvoice{##1}}%
  \newcommand{\motivation}[1]{\def\npcmotivation{##1}}%
  \newcommand{\secrets}[1]{\def\npcsecrets{##1}}%
}{%
  % End of environment - now render the box
  \begin{tcolorbox}[
    enhanced,
    colback=NPCBG,
    colframe=NPCBorder,
    fonttitle=\bfseries\large,
    title=\npcname,
    sharp corners=all,
    boxrule=1.5pt,
    left=8pt, right=8pt, top=10pt, bottom=8pt,
    before skip=10pt plus 2pt,
    after skip=10pt plus 2pt
  ]
  % Render subtitle if provided
  \ifx\npcsubtitle\empty
  \else
    {\small\itshape\npcsubtitle}
    \vspace{2mm}
    
  \fi
  
  % Render image if provided
  \ifx\npcimagedata\empty
  \else
    \begin{center}
      \includegraphics[width=0.9\linewidth]{\npcimagedata}
    \end{center}
    \vspace{3mm}
  \fi
  
  % Render fields
  \ifx\npcappearance\empty\else
    \textbf{Apariencia:} \npcappearance
    \vspace{2mm}
    
  \fi
  
  \ifx\npcvoice\empty\else
    \textbf{Voz:} \npcvoice
    \vspace{2mm}
    
  \fi
  
  \ifx\npcmotivation\empty\else
    \textbf{Motivación:} \npcmotivation
    \vspace{2mm}
    
  \fi
  
  \ifx\npcsecrets\empty\else
    \textbf{Secretos:} \npcsecrets
  \fi
  
  \end{tcolorbox}
}

% Widget 4: Image with Black Border (Evolved)
\NewDocumentCommand{\imagerim}{ m o }{
  \begin{tcolorbox}[
    enhanced,
    colframe=black,
    colback=white,
    boxrule=3pt,
    sharp corners,
    left=0pt, right=0pt, top=0pt, bottom=0pt,
    boxsep=0pt,
    middle=3pt % Thickness of the segmentation line
  ]
    \includegraphics[width=\linewidth]{#1}
    \IfValueT{#2}{
      \begin{center}
        \vspace{-8pt}
        \itshape #2
        \vspace{4pt}
      \end{center}
    }
  \end{tcolorbox}
}

\title{Ecos del Alba Perdida \\ \large Módulo para Rolemaster Unified}
\author{}
\date{}

\begin{document}

\maketitle

\tableofcontents

% ============================================================================
% INTRODUCTION - Geografía y Ambientación
% ============================================================================
\include{intro/intro}

% ============================================================================
% ACT I - Captura
% ============================================================================
\include{act_I/act_I}

% ============================================================================
% ACT II - (Placeholder for future acts)
% ============================================================================
% \include{act_II/act_II}

% ============================================================================
% ACT III - (Placeholder for future acts)
% ============================================================================
% \include{act_III/act_III}

\end{document}
